<!doctype HTML>
<html>
<head>
  <title>Luxcure - Buyer</title>
  <script src="./javascripts/jquery-3.2.1.js"></script>
  <script src="./javascripts/utils.js"></script>
  <script src="./javascripts/tether.js"></script>
  <script src="./javascripts/bootstrap.min.js"></script>
  <script src="./javascripts/web3.js"></script>
  <link rel="stylesheet"  type="text/css" href="./stylesheets/bootstrap.min.css"/>
  <link rel="stylesheet"  type="text/css" href="./stylesheets/app.css"/>

  <script>
  if (typeof web3 !== 'undefined') {
web3 = new Web3(web3.currentProvider);
} else {
// set the provider you want from Web3.providers
web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}
//Add text field to change account buyer for web3 eth address

var contract_abi = web3.eth.contract([
  {
    "constant": false,
    "inputs": [
      {
        "name": "_model",
        "type": "bytes32"
      },
      {
        "name": "_status",
        "type": "bytes32"
      },
      {
        "name": "_date_manufactured",
        "type": "bytes32"
      }
    ],
    "name": "addNewGoods",
    "outputs": [
      {
        "name": "",
        "type": "bool"
      }
    ],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getManufacturer",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "model",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {
        "name": "_owner",
        "type": "uint256"
      }
    ],
    "name": "getOwnerByIndex",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "status",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_stats",
        "type": "bytes32"
      }
    ],
    "name": "setStatus",
    "outputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "log_count",
    "outputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "contract_owner",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_buyer",
        "type": "address"
      }
    ],
    "name": "sendEther",
    "outputs": [],
    "payable": true,
    "stateMutability": "payable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getStatus",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "owners_count",
    "outputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_log",
        "type": "bytes32"
      }
    ],
    "name": "addRepairInfo",
    "outputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "owners_list",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getModel",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getCurrentOwner",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getNumberOfOwners",
    "outputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "date_manufactured",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getPreviousOwner",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "repairs",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_transfer_owner",
        "type": "address"
      }
    ],
    "name": "transferOwnership",
    "outputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getDateManufactured",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "constructor"
  }
]);
var ethereum_address;
var contract;

//Use the current ethereum user (No need private key)
function changeEthereumAddress(){
ethereum_address = document.getElementById("ethereum_address").value;
web3.eth.defaultAccount = ethereum_address;
alert("Changed the user to "+ethereum_address);
}

//Change the contract address
function changeContract(){
  contract_address = document.getElementById("smart_contract").value;
  contract  = contract_abi.at(contract_address);
  alert("Working on smart contract "+contract_address);
}

/*
1) Get the original manufacturer address and verify it
2) Latest owner
3) Get model,status and data Manufactured
4) List of previous ownership
5) Number of ownership
6) OPTIONAL - repairs done on good
*/
function verificationOfManAndLatestOwner(){
  var manufacturer_verify; // 1)
  var latest_owner = contract.getCurrentOwner(); // 2)
  var model = web3.toAscii(contract.getModel());   //3)
  var status = web3.toAscii(contract.getStatus()); //3)
  var date_manufactured = web3.toAscii(contract.getDateManufactured()); //3)
  var list = '';  // 4)
  var no_owners = contract.getNumberOfOwners(); //5)

  for(index = 0; index < no_owners; index++){
  list += contract.getOwnerByIndex(index) + "\n";
  }

  contract.getManufacturer(function(error,manufacturer){
    if(!error){
      if("0x2fb350c462e3d20bd4637d0e1d60079c4ae3229a" == manufacturer){
          manufacturer_verify = "Smart contract original owner correspond to the manufacturer Ethereum address. \n  ";
      }
      else{
          manufacturer_verify = "Not original manufacturer. \n ";
      }
    }
  });

  document.getElementById('contract_information').value = manufacturer_verify+"\n The latest owner is "+latest_owner+".\n Model: "
                                                          +model+". \n Status: "+status+".\n Date manufactured: "+date_manufactured+ ".\n List of owners: "+list+".\n Number of owners: " +no_owners;

}//end verificationOfManAndLatestOwner

//Transfer ether to the contract to receive ownership
function sendEthertoContract(){
var payment_tx = contract.sendEther.sendTransaction(ethereum_address,{from:ethereum_address,
         value:web3.toWei(5, "ether")}
       );
       var new_owner = contract.getCurrentOwner();
       alert("The tx hash "+payment_tx+".\nOwnership of smart contract "+contract_address+" transferred to "+new_owner+".");
       
}//end sendEtherForContract
  </script>
</head>
<header>
  <nav class="navbar navbar-toggleable-md navbar-inverse bg-inverse">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="#">Luxcure</a>
  <div class="collapse navbar-collapse" id="navbarsExampleDefault">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item ">
        <a class="nav-link" href="./">Manufacturer</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="./consumer">Consumer/Seller</a>
      </li>
      <li class="nav-item">
        <a class="nav-link " href="./buyer">Buyer</a>
      </li>
    </ul>

  </div>
</nav>
</header>
<body>
  <h1>Proof-of-Existence goods authentication</h1>
  <h1>Verify manufacturer and owner while purchasing good</h1>
  <h1>Deploy a goods smart contract into an Ethereum Blockchain</h1>

  <div class="contentform">
    <div class="leftcontact">

    <div class="form-group">
      <p>Current account: </p>
        <select id="ethereum_address">
          <option value = "0x4a924aed785c1e83a48939fcc8ddda6b326a5f08">User 1: 0x4a924aed785c1e83a48939fcc8ddda6b326a5f08</option>
          <option value = "0x1ad5662a8b3c5883a097e52ccc3876ce889e063d">User 2: 0x1ad5662a8b3c5883a097e52ccc3876ce889e063d</option>
          <option value = "0x1fabfce5bde932f1ee61e7e15fa6df59bd8d11f6">User 3: 0x1fabfce5bde932f1ee61e7e15fa6df59bd8d11f6</option>
          <option value = "0xcf4399e78d577d00f1454b5198172eb3295977d2">User 4: 0xcf4399e78d577d00f1454b5198172eb3295977d2</option>
          <option value = "0x40b9c880b6bfe91302c1015ae5eea8de01bbf9ed">User 5: 0x40b9c880b6bfe91302c1015ae5eea8de01bbf9ed</option>
          <option value = "0x11af1cf9324e22e0028aa559e70c23e077e924ce">User 6: 0x11af1cf9324e22e0028aa559e70c23e077e924ce</option>
          <option value = "0x43b464d9450a5cef57e63765197dc83691d92eec">User 7: 0x43b464d9450a5cef57e63765197dc83691d92eec</option>
          <option value = "0x7a20e20fd8b785209fef40e0d7d4580b40183878">User 8: 0x7a20e20fd8b785209fef40e0d7d4580b40183878</option>
        </select>
      </div>

      <div class="form-group">
          <button type="submit" onclick="changeEthereumAddress();" class="bouton-contact">Update</button>
      </div>

      <div class="form-group">
        <p>Current smart contract: </p>
            <input type="text" name="smart_contract" id="smart_contract" placeholder="Enter smart contract address..."/>
            <button type="submit" onclick="changeContract();" class="bouton-contact">Change contract</button>
      </div>

      <div class="form-group">
        <p>Get smart contract information: </p>
          <textarea row="10" col="10" id="contract_information" name="contract_information"></textarea>
          <button type="submit" onclick="verificationOfManAndLatestOwner();" class="bouton-contact">Get information</button>
      </div>

  </div>

  <div class="rightcontact">

    <div class="form-group">
    <p>Send ether to smart contract to gain ownership of Certificate of Authentication (Smart Contract):</p>
      <input type="text" name="ethereum_contract_address" id="ethereum_contract_address" placeholder="Smart Contract Address ..." />
  <!--    <input type="text" name="ethereum_ether_amount" id="ethereum_ether_amount" placeholder="Enter amount to send ..." /> -->
    </div>
    <div class="form-group">
      <button type="submit" onclick="sendEthertoContract();" class="bouton-contact">Transfer ownership</button>
    </div>

  </div>

</div>
</body>
</html>
