<!doctype HTML>
<html>
<head>
  <title>Luxcure - Consumer</title>
  <script src="./javascripts/jquery-3.2.1.js"></script>
  <script src="./javascripts/utils.js"></script>
  <script src="./javascripts/tether.js"></script>
  <script src="./javascripts/bootstrap.min.js"></script>
  <script src="./javascripts/web3.js"></script>
  <script src="./javascripts/qrcode.js"></script>
  <link rel="stylesheet"  type="text/css" href="./stylesheets/bootstrap.min.css"/>
  <link rel="stylesheet"  type="text/css" href="./stylesheets/app.css"/>

  <script>
  if (typeof web3 !== 'undefined') {
web3 = new Web3(web3.currentProvider);
} else {
// set the provider you want from Web3.providers
web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
}

web3.eth.defaultAccount = web3.eth.accounts[0]; //Account from default account (manfacturer) should be consumer address [1]
var contract_abi = web3.eth.contract([
  {
    "constant": false,
    "inputs": [
      {
        "name": "_model",
        "type": "bytes32"
      },
      {
        "name": "_status",
        "type": "bytes32"
      },
      {
        "name": "_date_manufactured",
        "type": "bytes32"
      }
    ],
    "name": "addNewGoods",
    "outputs": [
      {
        "name": "",
        "type": "bool"
      }
    ],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getManufacturer",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "model",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {
        "name": "_owner",
        "type": "uint256"
      }
    ],
    "name": "getOwnerByIndex",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "status",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_stats",
        "type": "bytes32"
      }
    ],
    "name": "setStatus",
    "outputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "log_count",
    "outputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "contract_owner",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getStatus",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "owners_count",
    "outputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_log",
        "type": "bytes32"
      }
    ],
    "name": "addRepairInfo",
    "outputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "owners_list",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getModel",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getCurrentOwner",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getNumberOfOwners",
    "outputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "date_manufactured",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getPreviousOwner",
    "outputs": [
      {
        "name": "",
        "type": "address"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [
      {
        "name": "",
        "type": "uint256"
      }
    ],
    "name": "repairs",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [
      {
        "name": "_transfer_owner",
        "type": "address"
      }
    ],
    "name": "transferOwnership",
    "outputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "getDateManufactured",
    "outputs": [
      {
        "name": "",
        "type": "bytes32"
      }
    ],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "constructor"
  }
]);

// Deployed contract on the Blockchain
//todo: Should change to a drop downlist to retrieve goods you own base on ethereum address - need a db to associate user address to smart contract address

var contract;

//Change the contract being worked on
function workOnContract(){
  contract_address = document.getElementById("contract_address").value;
  contract  = contract_abi.at(contract_address);
  alert("Working on smart contract "+contract_address);
}

//Validate the the original owner belong to a manufacturer
function contractOwner(){
contract.getManufacturer(function(error,manufacturer){
  if(!error){
    if("0x2fb350c462e3d20bd4637d0e1d60079c4ae3229a" == manufacturer){
        document.getElementById('manufacturer').value = "Smart contract original owner correspond to the manufacturer Ethereum address. ";
    }
    else{
        document.getElementById('manufacturer').value = "Not original manufacturer.";
    }
  }
  else{
    console.log(error);
  }
});
}

//Get all owners from index 0 to latest
function getAllOwners(){
var no_of_people = contract.getNumberOfOwners();
var list = '';
for(index = 0; index < no_of_people; index++){
list += contract.getOwnerByIndex(index) + "\n";
}
var no_owners = contract.getNumberOfOwners();
document.getElementById('owners').value = "The previous owners are (from first to last)\n"+list+"\n Total number of owners: "+no_owners;
//alert("The previous owners are (from first to last)\n"+list);
} // end getAllOwners

//Trasnfer ownership from current 2nd owner to 3rd owner
function transferOwnership(){
var transfer_address = document.getElementById("ethereum_trans_address").value;
contract.transferOwnership.sendTransaction(transfer_address,{
    from:web3.eth.accounts[1],
    gas:4000000
});

var _current_owner = contract.getCurrentOwner();
alert("The owner has been changed to "+_current_owner);

}

//Change status of  the item from Available OR Stolen
//Stolen attribute can only be changed by the contract owner
function changeStatus(){
var status = web3.fromAscii(document.getElementById("status").value);

contract.setStatus.sendTransaction(status,{
  from:web3.eth.accounts[1],
  gas:4000000
});

contract.getStatus(function(error,status){
if(!error){
alert("The status has been changed to " +web3.toAscii(status));
}
else{
  console.log(error);
}
});

}

//Get the number of previous owners
// function noOfOwners(){
//  contract.getNumberOfOwners(function(error,number_of_owners){
//   if(!error){
//     document.getElementById('owners').value = number_of_owners;
//   }
//   else{
//     console.log(error);
//   }
// });
// }
  </script>
</head>
<header>
  <nav class="navbar navbar-toggleable-md navbar-inverse bg-inverse">
  <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="#">Luxcure</a>
  <div class="collapse navbar-collapse" id="navbarsExampleDefault">
    <ul class="navbar-nav mr-auto">
      <li class="nav-item ">
        <a class="nav-link" href="./manufacturer">Manufacturer</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="./consumer">Consumer/Seller</a>
      </li>
      <li class="nav-item">
        <a class="nav-link " href="./buyer">Buyer</a>
      </li>
    </ul>

  </div>
</nav>
</header>

<body>
  <h1>Proof-of-Existence goods authentication</h1>
    <h1>Deploy a goods smart contract into an Ethereum Blockchain</h1>
    <h1> Manufacturer owner is 0x2fb350c462e3d20bd4637d0e1d60079c4ae3229a</h1>
  <div class="contentform">
    <div id="sendmessage"> Your message has been sent successfully. Thank you. </div>


    <div class="leftcontact">
      <div class="form-group">
        <p>Change Smart Contract: <span>*</span></p>
         <span class="icon-case"><i class="fa fa-user"></i></span>
        <input type="text" name="contract_address" id="contract_address" data-rule="required" data-msg="Please enter correct address" placeholder="e.g 0x2fb350c462e3d20bd4..."/>
                <div class="validation"></div>
      </div>

      <div class="form-group">
        <button type="submit" onclick="workOnContract();" class="bouton-contact">Change to your contract</button>
      </div>

      <div class="form-group">
        <p>Validate Manufacturer: <span>*</span></p>
          <span class="icon-case"><i class="fa fa-user"></i></span>
            <input type="text" name="manufacturer" id="manufacturer" data-rule="required" data-msg="Please enter a model number before submiting" placeholder="Compare original owners..."/>
        </div>

      <div class="form-group">
        <button type="submit" onclick="contractOwner();" class="bouton-contact">Get original contract owner</button>
      </div>

      <div class="form-group">
        <p>History of all owners:</p>
          <textarea rows="10" cols="50" name="owners" id="owners" placeholder="Hit enter to get contract history..."></textarea>
      </div>

      <div class="form-group">
        <button type="submit" onclick="getAllOwners();" class="bouton-contact">Get history</button>
      </div>
  </div>

  <div class="rightcontact">
    <div class="form-group">
    <p>Transfer Ownership: <span>*</span></p>
    <span class="icon-case"><i class="fa fa-building-o"></i></span>
      <input type="text" name="ethereum_trans_address" id="ethereum_trans_address" data-rule="required" placeholder="Enter user ethereum address..."/>
              <div class="validation"></div>
    </div>

    <div class="form-group">
      <button type="submit" onclick="transferOwnership();" class="bouton-contact">Transfer ownership</button>
    </div>

    <div class="form-group">
    <p>Flag stolen: <span>*</span></p>
    <span class="icon-case"><i class="fa fa-info"></i></span>
    <select id="status">
      <option value = "Available">Available </option>
      <option value = "Stolen">Stolen </option>
    </select>
    </div>

    <div class="form-group">
      <button type="submit" onclick="changeStatus();" class="bouton-contact">Change status</button>
    </div>

    <div class="form-group">
      <div>
      <p>Generate QR code for contract address</p>
      <input type="text" id="text_qr_code" placeholder="Enter an Ethereum smart contract address here..."fa  style="width:80%"/>
      <div id="qrcode" style="width:100px; height:100px; margin-top:15px;"></div>
      </div>
    </br>
    </br>
    </br>
    </div>

  </div>

  </div>
  <script>
  //QR code
  var qrcode = new QRCode(document.getElementById("qrcode"), {
  	width : 100,
  	height : 100
  });

  function makeCode () {
  	var elText = document.getElementById("text_qr_code");
  	if (!elText.value) {
  		//alert("Input a text");
  		elText.focus();
  		return;
  	}

  	qrcode.makeCode(elText.value);
  }

  makeCode();

  $("#text_qr_code").
  	on("blur", function () {
  		makeCode();
  	}).
  	on("keydown", function (e) {
  		if (e.keyCode == 13) {
  			makeCode();
  		}
  	});
  </script>
</body>
</html>
